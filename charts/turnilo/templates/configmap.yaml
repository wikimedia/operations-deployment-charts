{{ include "mesh.configuration.configmap" . }}

---

apiVersion: v1
kind: ConfigMap
metadata:
  name: turnilo-config
  {{- include "base.meta.labels" . | indent 2 }}
  namespace: {{ .Release.Namespace }}
data:
  config.yaml: |
    # Config generated by Helm
    # The port on which the server will listen on
    port: {{ $.Values.app.turnilo_port }}
    trustProxy: {{ $.Values.config.turnilo.trust_proxy}}
    customization:
      # the shortner fails if it sees a port in the url, so the regex below is not quite perfect
      urlShortener: |
        const req = {
          url: 'https://mw-api-int.discovery.wmnet:4446/w/api.php?format=json&action=shortenurl',
          form: { url: url.replace(/http:\/\/localhost[:0-9]*/, '{{ $.Values.config.turnilo.url }}') },
          headers: {
            'Host': 'meta.wikimedia.org',
            'X-Forwarded-For': context.clientIp,
          },
          json: true,
        };
        return request.post(req).then(x => x.error ? x.error.info : x.shortenurl.shorturl);

    clusters:
      {{- toYaml $.Values.config.turnilo.clusters | nindent 6 }}

    datacubes:
      {{- toYaml $.Values.config.turnilo.datacubes | nindent 6 }}

---

apiVersion: v1
kind: ConfigMap
metadata:
  name: httpd-cas-site
  {{- include "base.meta.labels" . | indent 2 }}
  namespace: {{ .Release.Namespace }}
data:
  50-turnilo-wikimedia-org.conf: |
    # Config generated by Helm
    <VirtualHost *:{{ $.Values.httpd_cas.port }}>
        ServerName {{ $.Values.config.httpd_cas_site.server_name }}
        ServerSignature Off

        # Not used since this VHost will only act as proxy,
        # but it is needed to avoid error messages in the httpd
        # logs and logrotate crons.
        DocumentRoot /var/www

        CASLoginURL {{ $.Values.config.httpd_cas_site.cas_login_url }}
        CASValidateURL {{ $.Values.config.httpd_cas_site.cas_validate_url }}
        CASDebug {{ $.Values.config.httpd_cas_site.cas_debug }}
        CASRootProxiedAs {{ $.Values.config.httpd_cas_site.cas_root_proxied_as }}
        CASCookiePath {{ $.Values.config.httpd_cas_site.cas_cookie_path }}
        CASVersion 2
        CASCertificatePath /etc/ssl/certs
        CASAttributePrefix X-CAS-
        CASAttributeDelimiter :
        CASValidateSAML Off
        CASSSOEnabled On
        CASCookieSameSite Lax
        CASCookieSecure On
        CASTimeout 7200
        CASIdleTimeout 3600

        <Directory />
            Options FollowSymLinks
            AllowOverride None
            Require all denied
            <Files health_check>
                Require all granted
            </Files>
        </Directory>

        <Location />
              AuthType CAS
              CASAuthNHeader CAS-User
              CASScope /
              {{- range $ldapGroup := $.Values.config.httpd_cas_site.cas_ldap_groups }}
              Require cas-attribute memberOf:cn={{$ldapGroup}},ou=groups,dc=wikimedia,dc=org
              {{- end }}
        </Location>

        <Location /health_check>
            Require all granted
            Alias {{ $.Values.config.httpd_cas_site.health_check_path }}
        </Location>

        # Redirecting logs to stdout and stderr
        CustomLog /dev/stdout combined
        ErrorLog /dev/stderr
        LogLevel warn

        ProxyPass /health_check !
        ProxyPass / http://localhost:{{$.Values.app.turnilo_port}}/
        ProxyPassReverse / http://localhost:{{$.Values.app.turnilo_port}}/
    </VirtualHost>

---

apiVersion: v1
kind: ConfigMap
metadata:
  name: httpd-cas-health-check
  {{- include "base.meta.labels" . | indent 2 }}
  namespace: {{ .Release.Namespace }}
data:
  health_check: |
    OK
