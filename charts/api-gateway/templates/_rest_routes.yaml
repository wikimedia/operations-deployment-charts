{{- define "restgateway.routes" }}
            name: restgateway_route
            virtual_hosts:
            - name: restgateway_vhost
              domains:
{{- range $domain := .Values.main_app.domains }}
              - "{{ $domain }}"
{{- end }}
{{- if .Values.main_app.ratelimiter.enabled }}
              rate_limits:
              - actions:
                - generic_key:
                    descriptor_key: limit_group
                    descriptor_value: "experiment-2025"
                - metadata:
                    descriptor_key: user_class
                    source: DYNAMIC
                    metadata_key:
                      key: wmf.rest_gateway.rate_limit
                      path:
                        - key: user_class
                - metadata:
                    descriptor_key: user_id
                    source: DYNAMIC
                    metadata_key:
                      key: wmf.rest_gateway.rate_limit
                      path:
                        - key: user_id
{{- end }}
              routes:
              - name: rest_gateway_root
                match:
                  path: "/"
                direct_response:
                  status: 200
                  body: {inline_string: "This is the REST Gateway."}
{{- /* BEGIN rest_gateway_routes definition */}}
{{- range $endpoint := .Values.main_app.rest_gateway_routes }}
{{- range $route := $endpoint.urls }}
{{- $cluster_name := ternary $endpoint.name $endpoint.cluster (not $endpoint.cluster) }}
              - name: {{ $endpoint.name }}_{{ $route.name }}
                match:
                  safe_regex:
                    regex: '^{{ $route.in }}$'
                  {{- if $endpoint.domain }}
                  headers:
                  - name: ':authority'
                    string_match:
                      exact: '{{ $endpoint.domain }}'
                  {{- end }}
                  {{- if $route.params}}
                  query_parameters:
                  {{- range $param := $route.params }}
                  - name: {{ $param }}
                    present_match: true
                  {{- end }}
                  {{- end }}
                {{- if not $route.disable_route_stats }}
                {{- if $endpoint.stat_prefix }}
                stat_prefix: {{ $endpoint.stat_prefix }}_{{ $route.name }}
                {{- else }}
                stat_prefix: {{ $endpoint.name }}_{{ $route.name }}
                {{- end }}
                {{- end }}
                {{- if $endpoint.request_headers_to_add }}
                request_headers_to_add:
                {{- range $rqh := $endpoint.request_headers_to_add }}
                  - header:
                      key: "{{ $rqh.key }}"
                      value: "{{ $rqh.value }}"
                    append_action: OVERWRITE_IF_EXISTS_OR_ADD
                {{- end }}
                {{- end }}
                response_headers_to_add:
                  - header:
                      key: "Via"
                      value: "rest-gateway"
                    append_action: OVERWRITE_IF_EXISTS_OR_ADD
                {{- if or $endpoint.response_headers_to_add $endpoint.rb_response_headers }}
                {{- range $rsh := $endpoint.response_headers_to_add }}
                  - header:
                      key: "{{ $rsh.key }}"
                      value: "{{ $rsh.value }}"
                    append_action: OVERWRITE_IF_EXISTS_OR_ADD
                {{- end }}
                {{- if $endpoint.rb_response_headers }}
                  - header:
                      key: "access-control-allow-origin"
                      value: "*"
                    append_action: OVERWRITE_IF_EXISTS_OR_ADD
                  - header:
                      key: "access-control-allow-methods"
                      value: "GET,HEAD"
                    append_action: OVERWRITE_IF_EXISTS_OR_ADD
                  - header:
                      key: "access-control-allow-headers"
                      value: "accept, content-type, content-length, cache-control, accept-language, api-user-agent, if-match, if-modified-since, if-none-match, dnt, accept-encoding"
                    append_action: OVERWRITE_IF_EXISTS_OR_ADD
                  - header:
                      key: "access-control-expose-headers"
                      value: "etag"
                    append_action: OVERWRITE_IF_EXISTS_OR_ADD
                  - header:
                      key: "x-content-type-options"
                      value: "nosniff"
                    append_action: OVERWRITE_IF_EXISTS_OR_ADD
                  - header:
                      key: "x-frame-options"
                      value: "SAMEORIGIN"
                    append_action: OVERWRITE_IF_EXISTS_OR_ADD
                  - header:
                      key: "referrer-policy"
                      value: "origin-when-cross-origin"
                    append_action: OVERWRITE_IF_EXISTS_OR_ADD
                  - header:
                      key: "x-xss-protection"
                      value: "1; mode=block"
                    append_action: OVERWRITE_IF_EXISTS_OR_ADD
                {{- end }}
                {{- end }}
                route:
                  regex_rewrite:
                    pattern:
                      regex: '^{{ $route.in }}$'
                    substitution: '{{ $route.out }}'
                  timeout: {{ $endpoint.timeout | default "15s" }}
                  cluster: {{ $cluster_name }}_cluster
                  {{- if $endpoint.ingress }}
                  auto_host_rewrite: true
                  {{- end }}
                {{- /* Per route filter config overrides */}}
                typed_per_filter_config:
                  {{- /* CSP header handling */}}
                  envoy.filters.http.set_metadata:
                    "@type": type.googleapis.com/envoy.extensions.filters.http.set_metadata.v3.Config
                    metadata:
                      - metadata_namespace: wmf.rest_gateway.csp
                        allow_overwrite: true
                        value:
                          {{- if hasKey $endpoint "csp_enabled" }}
                          enabled: {{ $endpoint.csp_enabled }}
                          {{- else }}
                          enabled: true
                          {{- end }}
                {{- /* Rate limiting override */}}
                {{- /* TODO: make apply_rate_limiting default to true */ -}}
                {{- if $.Values.main_app.ratelimiter.enabled }}
                {{- if not ( $endpoint.apply_rate_limiting | default false ) }}
                  envoy.filters.http.ratelimit:
                    "@type": type.googleapis.com/envoy.extensions.filters.http.ratelimit.v3.RateLimitPerRoute
                    vh_rate_limits: IGNORE
                {{- end }}
                {{- end }}

{{- end }}
{{- end }}
{{- /* END rest_gateway_routes definition */}}


{{- end }}
