{{- define "restgateway.rate_limit_actions" }}
# NOTE: If one of the headers referenced below is not set, the rate limit is not applied.
- generic_key: # Select the rate limit regime to apply
    descriptor_key: policy
    descriptor_value: {{ .policy }}
- request_headers: # Specify the rate limit class.
    descriptor_key: user_class
    header_name: x-wmf-user-class
- request_headers: # Provide the user's identity as the counter key.
    descriptor_key: user_id
    header_name: x-wmf-user-id
{{- end }}

{{- define "restgateway.routes" }}
            name: restgateway_route
            virtual_hosts:
            - name: restgateway_vhost
              domains:
{{- range $domain := .Values.main_app.domains }}
              - "{{ $domain }}"
{{- end }}
{{- if .Values.main_app.ratelimiter.enabled }}
              # Default rate limits, can be overridden per route.
              rate_limits:
              - actions:
                  {{- include "restgateway.rate_limit_actions" (dict "policy" .Values.main_app.ratelimiter.default_policy "Values" .Values) | nindent 16 }}
{{- end }}
              routes:
              - name: rest_gateway_root
                match:
                  path: "/"
                direct_response:
                  status: 200
                  body: {inline_string: "This is the REST Gateway."}
{{- /* BEGIN rest_gateway_routes definition */}}
{{- range $endpoint := .Values.main_app.rest_gateway_routes }}
{{- range $route := $endpoint.urls }}
{{- $cluster_name := ternary $endpoint.name $endpoint.cluster (not $endpoint.cluster) }}
              - name: {{ $endpoint.name }}_{{ $route.name }}
                match:
                  safe_regex:
                    regex: '^{{ $route.in }}$'
                  {{- if $endpoint.domain }}
                  headers:
                  - name: ':authority'
                    string_match:
                      exact: '{{ $endpoint.domain }}'
                  {{- end }}
                  {{- if $route.params}}
                  query_parameters:
                  {{- range $param := $route.params }}
                  - name: {{ $param }}
                    present_match: true
                  {{- end }}
                  {{- end }}
                {{- if not $route.disable_route_stats }}
                {{- if $endpoint.stat_prefix }}
                stat_prefix: {{ $endpoint.stat_prefix }}_{{ $route.name }}
                {{- else }}
                stat_prefix: {{ $endpoint.name }}_{{ $route.name }}
                {{- end }}
                {{- /* If require_opt_in is true or apply_rate_limiting is false, ignore global rate limits. */}}
                {{- /* If use_rate_limit_policy is set, ignore global rate limits and generate rate limit actions  */}}
                {{- if $.Values.main_app.ratelimiter.enabled }}
                {{- $apply_rate_limiting := ternary $endpoint.apply_rate_limiting (not $.Values.main_app.ratelimiter.require_opt_in) (hasKey $endpoint "apply_rate_limiting") }}
                {{- $use_rate_limit_policy := ternary $endpoint.use_rate_limit_policy false (hasKey $endpoint "use_rate_limit_policy") }}
                {{- if ( or (not $apply_rate_limiting) $use_rate_limit_policy ) }}
                typed_per_filter_config:
                  envoy.filters.http.ratelimit:
                    "@type": type.googleapis.com/envoy.extensions.filters.http.ratelimit.v3.RateLimitPerRoute
                    {{- if not $apply_rate_limiting }}
                    vh_rate_limits: IGNORE
                    {{- end }}
                    {{- if (and $use_rate_limit_policy $apply_rate_limiting ) }}
                    rate_limits:
                      - actions:
                          {{- include "restgateway.rate_limit_actions" ( dict "policy" $use_rate_limit_policy "Values" .Values ) | nindent 24}}
                    {{- end }}
                {{- end }}

                {{- end }}
                {{- end }}
                {{- if $endpoint.request_headers_to_add }}
                request_headers_to_add:
                {{- range $rqh := $endpoint.request_headers_to_add }}
                  - header:
                      key: "{{ $rqh.key }}"
                      value: "{{ $rqh.value }}"
                    append_action: OVERWRITE_IF_EXISTS_OR_ADD
                {{- end }}
                {{- end }}
                response_headers_to_add:
                  - header:
                      key: "Via"
                      value: "rest-gateway"
                    append_action: OVERWRITE_IF_EXISTS_OR_ADD
                {{- if or $endpoint.response_headers_to_add $endpoint.rb_response_headers }}
                {{- range $rsh := $endpoint.response_headers_to_add }}
                  - header:
                      key: "{{ $rsh.key }}"
                      value: "{{ $rsh.value }}"
                    append_action: OVERWRITE_IF_EXISTS_OR_ADD
                {{- end }}
                {{- if $endpoint.rb_response_headers }}
                  - header:
                      key: "access-control-allow-origin"
                      value: "*"
                    append_action: OVERWRITE_IF_EXISTS_OR_ADD
                  - header:
                      key: "access-control-allow-methods"
                      value: "GET,HEAD"
                    append_action: OVERWRITE_IF_EXISTS_OR_ADD
                  - header:
                      key: "access-control-allow-headers"
                      value: "accept, content-type, content-length, cache-control, accept-language, api-user-agent, if-match, if-modified-since, if-none-match, dnt, accept-encoding"
                    append_action: OVERWRITE_IF_EXISTS_OR_ADD
                  - header:
                      key: "access-control-expose-headers"
                      value: "etag"
                    append_action: OVERWRITE_IF_EXISTS_OR_ADD
                  - header:
                      key: "x-content-type-options"
                      value: "nosniff"
                    append_action: OVERWRITE_IF_EXISTS_OR_ADD
                  - header:
                      key: "x-frame-options"
                      value: "SAMEORIGIN"
                    append_action: OVERWRITE_IF_EXISTS_OR_ADD
                  - header:
                      key: "referrer-policy"
                      value: "origin-when-cross-origin"
                    append_action: OVERWRITE_IF_EXISTS_OR_ADD
                  - header:
                      key: "x-xss-protection"
                      value: "1; mode=block"
                    append_action: OVERWRITE_IF_EXISTS_OR_ADD
                {{- end }}
                {{- end }}
                {{- if (or $endpoint.csp_enabled (not (hasKey $endpoint "csp_enabled"))) }}
                  - header:
                      key: "content-security-policy"
                      value: "default-src 'none'; frame-ancestors 'none'"
                    append_action: ADD_IF_ABSENT
                {{- end }}
                route:
                  regex_rewrite:
                    pattern:
                      regex: '^{{ $route.in }}$'
                    substitution: '{{ $route.out }}'
                  timeout: {{ $endpoint.timeout | default "15s" }}
                  cluster: {{ $cluster_name }}_cluster
                  {{- if $endpoint.ingress }}
                  auto_host_rewrite: true
                  {{- end }}
                {{- /* Per route filter config overrides */}}
                {{- /* Rate limiting override */}}
                {{- /* TODO: make apply_rate_limiting default to true */ -}}
                {{- if $.Values.main_app.ratelimiter.enabled }}
                {{- if not ( $endpoint.apply_rate_limiting | default false ) }}
                typed_per_filter_config:
                  envoy.filters.http.ratelimit:
                    "@type": type.googleapis.com/envoy.extensions.filters.http.ratelimit.v3.RateLimitPerRoute
                    vh_rate_limits: IGNORE
                  envoy.filters.http.lua:
                    "@type": type.googleapis.com/envoy.extensions.filters.http.lua.v3.LuaPerRoute
                    disabled: true
                {{- end }}
                {{- else }}
                typed_per_filter_config:
                  envoy.filters.http.lua:
                    "@type": type.googleapis.com/envoy.extensions.filters.http.lua.v3.LuaPerRoute
                    disabled: true
                {{- end }}

{{- end }}
{{- end }}
{{- /* END rest_gateway_routes definition */}}


{{- end }}
