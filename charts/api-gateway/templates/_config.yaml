{{- define "config.app.cookie_to_metadata" }}
- cookie: {{ . }}
  on_header_present:
    metadata_namespace: envoy.wmf_cookies
    key: {{ . }}
    type: STRING
  on_header_missing:
    metadata_namespace: envoy.wmf_cookies
    key: {{ . }}
    value: '#NONE#' # Empty values are not allowed!
    type: STRING
  remove: false
{{- end }}
{{- define "config.app" }}
# api gateway envoy config
{{ if .Values.main_app.telemetry_port -}}
admin:
  access_log:
    typed_config:
      "@type": type.googleapis.com/envoy.extensions.access_loggers.stream.v3.StdoutAccessLog
  address:
    socket_address:
      protocol: TCP
      address: 127.0.0.1
      port_value: 1666
  # Don't apply global connection limits to the admin listener so we can still get metrics when overloaded
  ignore_global_conn_limit: true
{{ end -}}
overload_manager:
  resource_monitors:
    # Limit the total number of allowed active connections per envoy instance.
    # Envoy's configuration best practice "Configuring Envoy as an edge proxy" uses 50k connections
    # which is still essentially unlimited in our use case.
    - name: envoy.resource_monitors.global_downstream_max_connections
      typed_config:
        '@type': type.googleapis.com/envoy.extensions.resource_monitors.downstream_connections.v3.DownstreamConnectionsConfig
        max_active_downstream_connections: 50000
static_resources:
  listeners:
{{- if .Values.main_app.telemetry_port }}
  - name: telemetry_listener
    address:
      socket_address:
        address: 0.0.0.0
        port_value: {{ .Values.main_app.telemetry_port }}
    filter_chains:
    - filters:
      - name: envoy.http_connection_manager
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
          http_filters:
          - name: envoy.health_check
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.http.health_check.v3.HealthCheck
              pass_through_mode: false
              headers:
                - name: ":path"
                  string_match:
                    exact: "/healthz"
          - name: envoy.filters.http.router
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router
          http_protocol_options: {accept_http_10: true}
          route_config:
            virtual_hosts:
            - domains: ['*']
              name: admin_cluster
              routes:
              - match:
                  prefix: /metrics
                route:
                  cluster: admin_cluster
                  prefix_rewrite: "/stats/prometheus"
              - match:
                  prefix: /stats
                route:
                  cluster: admin_cluster
                  prefix_rewrite: "/stats"
                  timeout: 5.0s
              - match:
                  prefix: /
                direct_response:
                  status: 403
                  body: {inline_string: "You can't access this url."}
          stat_prefix: admin_cluster
          internal_address_config:
            unix_sockets: true
            cidr_ranges:
            - address_prefix: 10.0.0.0
              prefix_len: 8
            - address_prefix: 127.0.0.1
              prefix_len: 32
            - address_prefix: ::1
              prefix_len: 128
    # Don't apply global connection limits to the admin listener so we can still get metrics when overloaded
    ignore_global_conn_limit: true
{{- end }}
  - name: listener_0
    address:
      socket_address:
        protocol: TCP
        address: 0.0.0.0
        port_value: {{ .Values.app.port }}
    filter_chains:
    - filters:
      - name: envoy.filters.network.http_connection_manager
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
          stat_prefix: ingress_http
          # if set by upstream, use the supplied Server header
          server_header_transformation: APPEND_IF_ABSENT
          # configure logging
          access_log:
            name: envoy.file_access_log
            filter:
{{- if .Values.main_app.access_log.enable }}
              and_filter:
                filters:
                  - not_health_check_filter: {}
{{- if .Values.main_app.access_log.sample_percentage }}
                  - runtime_filter:
                      # This is a required-optional value read from
                      # runtime that is used for overriding - we don't
                      # want to do that so use a junk value.
                      runtime_key: "key_never_used_optional_required"
                      percent_sampled:
                        numerator: {{ .Values.main_app.access_log.sample_percentage}}
                        denominator: HUNDRED
{{- end }}
{{- else }}
              or_filter:
                filters:
                  - status_code_filter:
                      comparison:
                        op: "GE"
                        value:
                          default_value: 500
                          runtime_key: rest_gateway_min_log_code
{{- if .Values.main_app.access_log.sample_percentage }}
                  - runtime_filter:
                      # This is a required-optional value read from
                      # runtime that is used for overriding - we don't
                      # want to do that so use a junk value.
                      runtime_key: "key_never_used_optional_required"
                      percent_sampled:
                        numerator: {{ .Values.main_app.access_log.sample_percentage}}
                        denominator: HUNDRED
{{- end }}
{{- end }}
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.access_loggers.file.v3.FileAccessLog
              path: /dev/stdout
              log_format:
                omit_empty_values: true
                json_format:
                  $schema: "/api-gateway/request/1.0.0"
                  meta:
                    uri: "%REQ(X-ENVOY-ORIGINAL-PATH?:PATH)%"
                    request_id: "%REQ(X-REQUEST-ID)%"
                    dt: "%START_TIME(%FT%TZ)%"
                    domain: "%REQ(HOST)%"
                    stream: "api-gateway.request"
                  http:
                    method: "%REQ(:METHOD)%"
                    protocol: "%PROTOCOL%"
                    status_code: "%RESPONSE_CODE%"
                    client_ip: "%REQ(X-FORWARDED-FOR)%"
                    request_headers:
                      user-agent: "%REQ(USER-AGENT)%"
                      # Headers generated by CDN, see https://wikitech.wikimedia.org/wiki/CDN/Backend_api
                      x-trusted-request: "%REQ(X-TRUSTED-REQUEST)%"
                      x-is-browser: "%REQ(X-IS-BROWSER)%"
                      x-ua-contact: "%REQ(X-UA-CONTACT)%"
                      x-provenance: "%REQ(X-PROVENANCE)%"
                      # Headers generated by restgateway.lua
                      x-wmf-user-id: "%REQ(X-WMF-USER-ID)%"
                      x-wmf-ratelimit-class: "%REQ(X-WMF-RATELIMIT-CLASS)%"
                      x-wmf-ratelimit-policy: "%REQ(X-WMF-RATELIMIT-POLICY)%"
                  total_time_ms: "%DURATION%"
                  client_id: "%DYNAMIC_METADATA(envoy.filters.http.jwt_authn:jwt_payload:aud)%"
                  {{- if .Values.main_app.ratelimiter.key_log_format }}
                  ratelimit_key: {{ .Values.main_app.ratelimiter.key_log_format | quote }}
                  {{- end }}
                  route: "%ROUTE_NAME%"
          use_remote_address: true
{{- if .Values.main_app.normalise_paths }}
          normalize_path: true
{{- end }}
          local_reply_config:
            # Override the empty %LOCAL_REPLY_BODY% for 404 to "Not Found"
            mappers:
              - filter:
                  status_code_filter:
                    comparison:
                      op: EQ
                      value:
                        default_value: 404
                        runtime_key: unused_key_404
                body:
                  inline_string: "Not Found"
            # Default format applied to all error responses
            body_format:
              json_format:
                httpCode: "%RESPONSE_CODE%"
                httpReason: "%LOCAL_REPLY_BODY%"
          route_config:
{{- if .Values.main_app.rest_gateway_routes }}
{{ include "restgateway.routes" . }}
{{- else }}
{{ include "apigateway.routes" . }}
{{- end }}
          http_filters:
          - name: envoy.health_check
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.http.health_check.v3.HealthCheck
              pass_through_mode: false
              headers:
                - name: ":path"
                  string_match:
                    exact: "/healthz"
          - name: envoy.filters.http.cors
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.http.cors.v3.Cors

{{- if .Values.main_app.jwt.enabled }}
{{- if .Values.main_app.rest_gateway_routes }}
          - name: envoy.filters.http.jwt_authn
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.http.jwt_authn.v3.JwtAuthentication
              providers:
                wikimedia_token:
                  issuer: {{ .Values.main_app.jwt.issuer }}
                  local_jwks:
                    filename: /etc/jwks/jwks.json
                  forward: true
                  from_headers:
                    name: Authorization
                    value_prefix: Bearer
                  payload_in_metadata: "jwt_payload"
                wikimedia_cookie:
                  issuer: {{ .Values.main_app.jwt.issuer }}
                  local_jwks:
                    filename: /etc/jwks/jwks.json
                  forward: true
                  from_cookies:
                    - sessionJwt
                  payload_in_metadata: "cookie_payload"
              rules:
                - match:
                    headers:
                      - name: ":method"
                        string_match:
                          safe_regex:
                            regex: "(GET|POST|PUT|DELETE|PATCH)"
                    prefix: /
                  requires:
                    requires_all:
                      requirements:
                        - requires_any:
                            requirements:
                              - provider_name: wikimedia_token
                              - allow_missing: {} # reject expired tokens in headers
                        - requires_any:
                            requirements:
                              - provider_name: wikimedia_cookie
                              - allow_missing_or_failed: {} # ignore expired tokens in cookies
{{- else }}
          - name: envoy.filters.http.jwt_authn
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.http.jwt_authn.v3.JwtAuthentication
              providers:
                wikimedia:
                  issuer: {{ .Values.main_app.jwt.issuer }}
                  local_jwks:
                    filename: /etc/jwks/jwks.json
                  forward: true
                  from_headers:
                    name: Authorization
                    value_prefix: Bearer
                  payload_in_metadata: "jwt_payload"
              rules:
{{ include "apigateway.ratelimit_rules" . }}
{{- end }}
{{- end }}
{{- if not .Values.main_app.ratelimiter.enable_x_ratelimit_headers }}
          - name: envoy.filters.http.header_mutation
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.http.header_mutation.v3.HeaderMutation
              # Strip the DRAFT_VERSION_03 headers injected by ratelimiter.
              # We need them in Lua to set the retry-after header to the correct value.
              # After the Lua filter is complete we can remove them (note that filters are invoked
              # in reverse order for response handling).
              mutations:
                response_mutations:
                  - remove: "x-ratelimit-limit"
                  - remove: "x-ratelimit-remaining"
                  - remove: "x-ratelimit-reset"
{{- end }}
{{- if .Values.main_app.rest_gateway_routes }}
          {{- if .Values.main_app.ratelimiter.user_id_cookie }}
          - name: envoy.filters.http.header_to_metadata
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.http.header_to_metadata.v3.Config
              request_rules:
                # make a cookie for identifying the user available in Lua via metadata
                {{ include "config.app.cookie_to_metadata" .Values.main_app.ratelimiter.user_id_cookie | indent 16 }}
          {{- end }}
{{- /* Since we use Lua only for rate limiting, disable it if rate limiting is disabled. */ -}}
{{- if $.Values.main_app.ratelimiter.enabled }}
          - name: envoy.filters.http.lua
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.http.lua.v3.Lua
              default_source_code:
                inline_string: |
{{ include "restgateway.lua" . | indent 18 }}
{{- end }}
{{- end }}
{{- if .Values.main_app.ratelimiter.enabled }}
          - name: envoy.filters.http.ratelimit
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.http.ratelimit.v3.RateLimit
              domain: wikimedia
              stage: 0
              timeout: {{ .Values.main_app.ratelimiter.envoy_timeout }}s
              enable_x_ratelimit_headers: DRAFT_VERSION_03
              rate_limit_service:
                transport_api_version: V3
                grpc_service:
                  envoy_grpc:
                    cluster_name: rate_limit_cluster
{{- end }}
          - name: envoy.filters.http.header_to_metadata
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.http.header_to_metadata.v3.Config
              request_rules:
                {{- /*
                  NOTE: When adding a new metadata key extraction, be sure to update existing LB subset
                  use cases for compatibility. See discussion of metadata match for subset_selectors in:
                  https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/cluster/v3/cluster.proto#config-cluster-v3-cluster-lbsubsetconfig
                */}}
                - header: "x-wikimedia-debug"
                  on_header_present:
                    metadata_namespace: envoy.lb
                    key: x_wikimedia_debug_server
                    regex_value_rewrite:
                      pattern:
                        regex: "^backend=([\\w.]+).*$"
                      substitution: "\\1"
                  on_header_missing:
                    metadata_namespace: envoy.lb
                    key: x_wikimedia_debug_server
                    value: none
                    type: STRING
                - cookie: PHP_ENGINE
                  on_header_present:
                    metadata_namespace: envoy.lb
                    key: php_engine
                    type: STRING
                  on_header_missing:
                    metadata_namespace: envoy.lb
                    key: php_engine
                    value: none
                    type: STRING
          - name: envoy.filters.http.router
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router
          internal_address_config:
            unix_sockets: true
            cidr_ranges:
            - address_prefix: 10.0.0.0
              prefix_len: 8
            - address_prefix: 127.0.0.1
              prefix_len: 32
            - address_prefix: ::1
              prefix_len: 128
{{- if .Values.mesh.enabled }}
      transport_socket:
        name: envoy.transport_sockets.tls
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.DownstreamTlsContext
          common_tls_context:
            {{- if (.Values.mesh.certmanager | default dict).enabled }}
            {{- /*
            Configure envoy to read certificates from static SDS config.
            This will enable an inotify watcher and hot-reloading on certificate changes.
            */}}
            tls_certificate_sds_secret_configs:
              name: tls_sds
              sds_config:
                path_config_source:
                  path: /etc/envoy/tls_certificate_sds_secret.yaml
                resource_api_version: V3
            {{- else }}
            tls_certificates:
              - certificate_chain: {filename: /etc/envoy/ssl/service.crt}
                private_key: {filename: /etc/envoy/ssl/service.key}
            {{- end }}
{{- end }}
  clusters:
{{- /* BEGIN endpoints cluster definition */}}
{{- range $cluster_name, $cluster_opts := .Values.main_app.endpoints }}
{{- if $cluster_opts }}
{{- if $cluster_opts.hosts }}
  - name: {{ $cluster_name }}
    connect_timeout: 0.25s
    typed_extension_protocol_options:
      envoy.extensions.upstreams.http.v3.HttpProtocolOptions:
        "@type": type.googleapis.com/envoy.extensions.upstreams.http.v3.HttpProtocolOptions
        explicit_http_config:
          http_protocol_options: {}
        common_http_protocol_options:
          max_requests_per_connection: 1000
          idle_timeout: {{ $.Values.main_app.idle_timeout }}
    type: {{ $cluster_opts.type }}
    lb_policy: ROUND_ROBIN
    # required for non-ipv6 services on localhost or elsewhere
    dns_lookup_family: V4_ONLY
{{- if $cluster_opts.tls }}
    transport_socket:
      name: envoy.transport_sockets.tls
      typed_config:
        "@type": type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.UpstreamTlsContext
        common_tls_context:
          tls_params:
            tls_minimum_protocol_version: TLSv1_2
            cipher_suites: ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
          validation_context:
            trusted_ca:
              filename: /etc/ssl/certs/wmf-ca-certificates.crt
{{- end }}
    lb_subset_config:
      fallback_policy: "DEFAULT_SUBSET"
      default_subset:
        x_wikimedia_debug_server: none
        php_engine: none
      subset_selectors:
        - keys:
            - x_wikimedia_debug_server
            - php_engine
    load_assignment:
      cluster_name: {{ $cluster_name }}
      endpoints:
      - lb_endpoints:
{{- range $host, $port := $cluster_opts.hosts }}
        - endpoint:
            address:
              socket_address:
                address: {{ $host }}
                port_value: {{ $port }}
          metadata:
            filter_metadata:
              envoy.lb:
                x_wikimedia_debug_server: none
                php_engine: none
{{- end }}
{{- range $host, $port := $cluster_opts.debug_hosts }}
        - endpoint:
            address:
              socket_address:
                address: {{ $host }}
                port_value: {{ $port }}
          metadata:
            filter_metadata:
              envoy.lb:
                x_wikimedia_debug_server: {{ $host }}
                php_engine: none
{{- end }}
{{- end }}
{{- end }}
{{- end }}
{{- /* END endpoints cluster definition */}}
{{- /* BEGIN discovery cluster definition */}}
{{- range $cluster_name, $cluster_opts := .Values.main_app.discovery_endpoints }}
{{- $address := $cluster_opts.internal_host | default (printf  "%s.discovery.wmnet" $cluster_name )}}
  - name: {{ $cluster_name }}_cluster
    connect_timeout: 0.25s
    typed_extension_protocol_options:
      envoy.extensions.upstreams.http.v3.HttpProtocolOptions:
        "@type": type.googleapis.com/envoy.extensions.upstreams.http.v3.HttpProtocolOptions
        explicit_http_config:
          http_protocol_options: {}
        common_http_protocol_options:
          max_requests_per_connection: 1000
          idle_timeout: {{ $.Values.main_app.idle_timeout }}
{{- if $cluster_opts.php_engine_routing }}
    # A cluster with multiple lb_endpoints must use STRICT_DNS.
    type: STRICT_DNS
{{- else }}
    type: LOGICAL_DNS
{{- end }}
    lb_policy: ROUND_ROBIN
    # required for non-ipv6 services on localhost or elsewhere
    dns_lookup_family: V4_ONLY
{{- if $cluster_opts.tls }}
    transport_socket:
      name: envoy.transport_sockets.tls
      typed_config:
        "@type": type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.UpstreamTlsContext
        {{- if $cluster_opts.ingress }}
        sni: {{ $address }}
        {{- end }}
        common_tls_context:
          tls_params:
            tls_minimum_protocol_version: TLSv1_2
            cipher_suites: ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
          validation_context:
            trusted_ca:
              filename: /etc/ssl/certs/wmf-ca-certificates.crt
{{- end }}
{{- if $cluster_opts.php_engine_routing }}
    lb_subset_config:
      fallback_policy: "DEFAULT_SUBSET"
      default_subset:
        php_engine: none
        x_wikimedia_debug_server: none
      subset_selectors:
        - keys:
            - php_engine
            - x_wikimedia_debug_server
{{- end }}
    load_assignment:
      cluster_name: {{ $cluster_name }}_cluster
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: {{ $address }}
                port_value: {{ $cluster_opts.port }}
{{- if $cluster_opts.php_engine_routing }}
          metadata:
            filter_metadata:
              envoy.lb:
                php_engine: none
                x_wikimedia_debug_server: none
{{- range $cookie_value, $override_opts := $cluster_opts.php_engine_routing }}
        - endpoint:
            address:
              socket_address:
                address: {{ printf  "%s.discovery.wmnet" $override_opts.service_name }}
                port_value: {{ $override_opts.port }}
          metadata:
            filter_metadata:
              envoy.lb:
                php_engine: {{ $cookie_value | quote }}
                x_wikimedia_debug_server: none
{{- end }}
{{- end }}
{{- end }}
{{- /* END discovery cluster definition */}}
{{- if .Values.main_app.ratelimiter.enabled }}
  - name: rate_limit_cluster
    type: static
    connect_timeout: 0.25s
    lb_policy: ROUND_ROBIN
    typed_extension_protocol_options:
      envoy.extensions.upstreams.http.v3.HttpProtocolOptions:
        "@type": type.googleapis.com/envoy.extensions.upstreams.http.v3.HttpProtocolOptions
        explicit_http_config:
          http2_protocol_options: {}
    load_assignment:
      cluster_name: rate_limit_cluster
      endpoints:
        - lb_endpoints:
            - endpoint:
                address:
                  socket_address:
                    address: 127.0.0.1
                    port_value: {{ .Values.main_app.ratelimiter.port }}
{{- end }}
{{ if .Values.main_app.telemetry_port }}
  - name: admin_cluster
    type: static
    connect_timeout: 0.25s
    lb_policy: ROUND_ROBIN
    typed_extension_protocol_options:
      envoy.extensions.upstreams.http.v3.HttpProtocolOptions:
        "@type": type.googleapis.com/envoy.extensions.upstreams.http.v3.HttpProtocolOptions
        explicit_http_config:
          http2_protocol_options: {}
    load_assignment:
      cluster_name: admin_cluster
      endpoints:
        - lb_endpoints:
            - endpoint:
                address:
                  socket_address:
                    address: 127.0.0.1
                    port_value: 1666
{{- end }}
{{- end }}
