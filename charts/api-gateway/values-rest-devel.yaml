main_app:
  command: ~
  args: ["-l", "debug"]
  version: "1.26.8-1"
  http_https_echo: true
  access_log:
    #enabled: false
    sample_percentage: 100
  telemetry_port: 8089

  ratelimiter:
    shadow_mode: false
    allow_client_headers: true
    anon_limit:
      requests_per_unit: 2
      unit: MINUTE
    default_limit:
      requests_per_unit: 5
      unit: MINUTE

  domains:
    - localhost
    - localhost:*
    - 127.0.0.1
    - 127.0.0.1:*
    - restgateway.discovery.wmnet
    - mytestdomain.discovery.wmnet

  rest_gateway_routes:
    - name: mobileapps
      hostname: mobileapps.discovery.wmnet
      urls:
        #TODO tighten capture group criteria
        - name: ma_mobile_revision
          in: '(.+)/v1/page/mobile-html/(.+)/(.+)'
          out: '\1/v1/page/mobile-html/\2/\3'
        - name: ma_mobile_no_revision
          in: '(.+)/v1/page/mobile-html/(.+)'
          out: '\1/v1/page/mobile-html/\2'
        - name: ma_summary_revision
          in: '(.+)/v1/page/summary/(.+)/(.+)'
          out: '\1/v1/page/summary/\2/\3'
          route_stats: true
        - name: ma_summary_no_revision
          in: '(.+)/v1/page/summary/(.+)'
          out: '\1/v1/page/summary/\2'
      rb_response_headers: true
      apply_rate_limiting: true # opt into applying rate limits (redundant when require_opt_in is false)
    - name: other_mobileapps
      cluster: mobileapps
      no_csp: true
      urls:
        - name: random
          in: '(.+)/v1/page/oh-no/(.+)/(.+)'
          out: '\1/v1/page/oh-no/\2/\3'
      rb_response_headers: false
      apply_rate_limiting: false # opt out of applying rate limits (redundant when require_opt_in is true)
    - name: proton
      timeout: 150s
      ingress: true
      domain: mytestdomain.discovery.wmnet
      urls:
        #TODO tighten capture group criteria
        - name: proton_title
          in: '(.+)/v1/page/pdf/(.+)'
          out: '\1/v1/pdf/\2'
        - name: proton_title_format
          in: '(.+)/v1/page/pdf/(.+)/(.+)'
          out: '\1/v1/pdf/\2/\3'
        - name: proton_title_format_type
          in: '(.+)/v1/page/pdf/(.+)/(.+)/(.+)'
          out: '\1/v1/pdf/\2/\3/\4'
      rb_response_headers: true
      use_rate_limit_policy: "experiment-2025-shadow" # use shadow rate limits (override ratelimiter.default_policy)
    - name: citoid
      timeout: 120s
      urls:
        - name: citoid_query
          in: '(.+)/v1/data/citation/(.+)/(.+)'
          out: '/\2/\3'
      rb_response_headers: true
      use_rate_limit_policy: "experiment-2025" # use enforced rate limits (override ratelimiter.default_policy)

  discovery_endpoints:
    mobileapps:
      tls: false
      port: 8888
      internal_host: localhost
      host: localhost
    citoid:
      tls: false
      port: 8888
      internal_host: localhost
      host: localhost
    proton:
      tls: false
      port: 8888
      internal_host: localhost
      host: localhost
