## Render tests
The **chart render tests** check the manifests generated by the Helm chart.
They use value file fixtures to emulate different scenarios.

The easiest way to run the chart render tests is via Make from inside the `tests` directory:
To run only the chart render tests, use `make test-render`.
To run all offlines tests, use `make test`. 
Note that this will not run the [End-to-End Tests](#end-to-end-tests).

### System requirements
The chart render tests are located in the `render` directory, they are implemented
using the pyunit test framework which ships with Python.
They are offline tests, so they do not rely on Kubernetes, but they do require Helm.

Requirements:
* **python3**. If you want to run tests manually instead of using the Makefile, you will also need the `python` directory from the root of the `deployment-charts` repository in your `PYTHONPATH`.  
* **Helm**, at least version 3. If the Helm executable is not in the system path, you will need to set the `HELM_BIN` variable to point to the Helm executable. 

### Running render tests without Make

If you want to run the render tests directly without using make, you can use the following incantation from the `tests` directory:

```bash
PYTHONPATH=../../../python python3 -m unittest -v render/test_*.py
```

There are also "meta-tests" that test the framework used by the chart render tests.
They are located under render/test. To run them, use:

```bash
PYTHONPATH=../../../python python3 -m unittest -v render/test_*.py
```

## Lua Unit Tests
The **Lua unit tests** test the Lua code that will be injected into the Envoy configuration to helm implement rate limiting.

The easiest way to run the Lua unit tests is via Make from inside the `tests` directory:
To run only the chart render tests, use `make test-lua`.
To run all offlines tests, use `make test`.
Note that this will not run the [End-to-End Tests](#end-to-end-tests).

### System requirements
The Lua unit tests are located in the `lua` directory, they are implemented
using the `busted` test framework for Lua.
They are pure unit tests, so they don't need Kubernetes or Helm or Envoy.

Requirements:
* **Lua** 5.3 and the **luarocks** package manager.  
* The **busted** framework, installed via `luarocks install busted`. 

### Running Lua unit tests without Make

Lua tests reside in the `lua` directory. They can be run from the `tests` directory using `busted lua/test*.lua`.

## End-to-End Tests

End-to-end tests can be run against a local Minikube environment using Make from inside the `tests` directory.

The relevant Make targets are:

* `install`: uninstall gateway using helm
* `uninstall`: install gateway using helm
* `reinstall`: uninstall then install
* `port-forward`: start port forwarding
* `check`: run end-to-end tests against minikube environment
* `logs`: show logs from gateway pod

Note that the `check` commands delegates to the makefile in the helmfile
directory for the rest-gateway service, and relies on the value files define there.

### Running end-to-end tests
First, install the chart into your local minikube environment. If minikube is not yet runnig, start it with `minikube start`.
Then run `make install` or, if a previous instllation is already running, `make reinstall`. Note that bringing up the service in minikube may take a couple of minutes.

Next, make the gateway available to on the host machine using `make port-forward`. This command will not return until you cancel it, so best run in a separate terminal. Note that `make port-forward` needs to be re-started every time you re-install the chart. If it is not restarted, it will remain running, but forwarding will fail, because the name of the gateway pod will have changed. 

Finally, run the end-to-end tests with `make check`. If connection errors occur, check if port-forwarding needs to be started or re-started. If errors persist or port-forwarding fails to start, use `make logs` to show the logs from the gateway pod.

When testing is complete, you can tear down the test environment using `make uninstall` and `minikube stop`.

### System requirements
* **Minikube**
* **kubectl**