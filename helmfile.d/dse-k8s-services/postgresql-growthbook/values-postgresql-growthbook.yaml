cluster:
  version: 17
  imageName: docker-registry.discovery.wmnet/repos/data-engineering/postgresql-kubernetes/postgresql-documentdb
  shared_preload_libraries:
  # Cf https://github.com/FerretDB/documentdb/blob/3f80da90a9e0b04f214183aa656c4fb0b4bc31e4/scripts/utils.sh#L132C22-L132C29
  - pg_cron
  # Cf https://github.com/FerretDB/documentdb/blob/3f80da90a9e0b04f214183aa656c4fb0b4bc31e4/scripts/start_oss_server.sh#L79C19-L79C37
  # and https://github.com/FerretDB/documentdb/blob/3f80da90a9e0b04f214183aa656c4fb0b4bc31e4/scripts/start_oss_server.sh#L140
  - pg_documentdb_core
  - pg_documentdb

  postgresql:
    # Cf https://github.com/FerretDB/documentdb/blob/3f80da90a9e0b04f214183aa656c4fb0b4bc31e4/scripts/utils.sh#L134
    cron.database_name: app
    documentdb.enableBackgroundWorker: 'true'
    documentdb.enableBackgroundWorkerJobs: 'true'

  pg_hba:
    - host app app 127.0.0.1/32 trust
    - host app app ::1/128 trust

  initdb:
    # database: postgres
    # owner: postgres
    postInitApplicationSQL:
    # Cf https://github.com/FerretDB/documentdb/blob/3f80da90a9e0b04f214183aa656c4fb0b4bc31e4/packaging/20-install.sql#L1
    - CREATE EXTENSION IF NOT EXISTS documentdb CASCADE;
    # Cf https://github.com/citusdata/pg_cron/issues/48#issuecomment-386207327
    # uses a unix socket to connect to PG from the master instead of TCP
    - UPDATE cron.job SET nodename = '';

    # Cf https://phabricator.wikimedia.org/T406579#11310800
    - ALTER SCHEMA cron OWNER TO app;
    - ALTER SCHEMA documentdb_api OWNER TO app;
    - ALTER SCHEMA documentdb_api_catalog OWNER TO app;
    - ALTER SCHEMA documentdb_api_internal OWNER TO app;
    - ALTER SCHEMA documentdb_core OWNER TO app;
    - ALTER SCHEMA documentdb_data OWNER TO app;

    # Cf https://phabricator.wikimedia.org/T406579#11311379
    - GRANT USAGE ON SCHEMA cron TO pg_monitor;
    - GRANT USAGE ON SCHEMA documentdb_api TO pg_monitor;
    - GRANT USAGE ON SCHEMA documentdb_api_catalog TO pg_monitor;
    - GRANT USAGE ON SCHEMA documentdb_api_internal TO pg_monitor;
    - GRANT USAGE ON SCHEMA documentdb_core TO pg_monitor;
    - GRANT USAGE ON SCHEMA documentdb_data TO pg_monitor;

    # Cf https://phabricator.wikimedia.org/T406579#11311474
    - GRANT documentdb_admin_role TO app;

pooler:
  enabled: false
