resources:
  # replicas: 4
  # Temporary bump for T402412 until ATS changes are merged to send
  # read traffic to the secondary datacentre.
  replicas: 6

main_app:
  version: 1.29.12-1
  telemetry_port: 1667

  access_log:
    # Disable access log but enable 5xx logging and sample 1%
    enabled: false
    sample_percentage: 1

  requests:
    cpu: 1
    memory: 1Gi
  limits:
    cpu: 2
    memory: 2Gi

  domains:
    - rest-gateway.discovery.wmnet
    - rest-gateway.discovery.wmnet:*
    - rest-gateway-ro.discovery.wmnet
    - rest-gateway-ro.discovery.wmnet:*
    - "*.wikipedia.org"
    - "*.m.mediawiki.org"
    - "*.m.wikibooks.org"
    - "*.m.wikidata.org"
    - "*.m.wikimedia.org"
    - "*.m.wikimediafoundation.org"
    - "*.m.wikinews.org"
    - "*.m.wikipedia.org"
    - "*.m.wikiquote.org"
    - "*.m.wikisource.org"
    - "*.m.wikiversity.org"
    - "*.m.wikivoyage.org"
    - "*.m.wiktionary.org"
    - "*.mediawiki.org"
    - "*.planet.wikimedia.org"
    - "*.wikibooks.org"
    - "*.wikidata.org"
    - "*.wikimedia.org"
    - "*.wikimediafoundation.org"
    - "*.wikinews.org"
    - "*.wikiquote.org"
    - "*.wikisource.org"
    - "*.wikiversity.org"
    - "*.wikivoyage.org"
    - "*.wiktionary.org"
    - "*.wmfusercontent.org"
    - "*.zero.wikipedia.org"
    - mediawiki.org
    - w.wiki
    - wikibooks.org
    - wikidata.org
    - wikimedia.org
    - wikimediafoundation.org
    - wikinews.org
    - wikiquote.org
    - wikisource.org
    - wikiversity.org
    - wikivoyage.org
    - wiktionary.org
    - wmfusercontent.org
    - wikipedia.org
    # required for service mesh
    - "localhost:6033"

  # FOOTGUN ALERT: routes are strictly ordered. This means that if you
  # have multiple rules that potentially overlap, the LESS general
  # case should be first. For example, it's very common for
  # post-restbase rules to support PATH/PAGE/REVISION and
  # PATH/PAGE. If you define a (.+) regex for PATH/PAGE *before*
  # PATH/PAGE/REVISION, this rule will get matched first and
  # PAGE/REVISION will be passed as a single capture group
  rest_gateway_routes:
    - name: mobileapps
      timeout: 120s
      urls:
        #TODO tighten capture group criteria
        - name: ma_mobile_revision
          in: '/+([^/]+)/v1/page/mobile-html/(.+)/(.+)'
          out: '/\1/v1/page/mobile-html/\2/\3'
        - name: ma_mobile_no_revision
          in: '/+([^/]+)/v1/page/mobile-html/(.+)'
          out: '/\1/v1/page/mobile-html/\2'
        - name: ma_summary_revision
          in: '/+([^/]+)/v1/page/summary/(.+)/(.+)'
          out: '/\1/v1/page/summary/\2/\3'
        - name: ma_summary_no_revision
          in: '/+([^/]+)/v1/page/summary/(.+)'
          out: '/\1/v1/page/summary/\2'
        - name: ma_media_list_revision
          in: '/+([^/]+)/v1/page/media-list/(.+)/(.+)'
          out: '/\1/v1/page/media-list/\2/\3'
        - name: ma_media_list_no_revision
          in: '/+([^/]+)/v1/page/media-list/(.+)'
          out: '/\1/v1/page/media-list/\2'
        - name: ma_mobile_html_offline_resources
          in: '/+([^/]+)/v1/page/mobile-html-offline-resources/(.+)/(.+)'
          out: '/\1/v1/page/mobile-html-offline-resources/\2/\3'
        - name: ma_mobile_html_offline_resources_no_revision
          in: '/+([^/]+)/v1/page/mobile-html-offline-resources/(.+)'
          out: '/\1/v1/page/mobile-html-offline-resources/\2'
        - name: ma_data_css_mobile
          in: '/+([^/]+)/v1/data/css/mobile/(.+)'
          out: '/\1/v1/data/css/mobile/\2'
        - name: ma_data_javascript_mobile
          in: '/+([^/]+)/v1/data/javascript/mobile/(.+)'
          out: '/\1/v1/data/javascript/mobile/\2'
        - name: ma_data_i18n
          in: '/+([^/]+)/v1/data/i18n/(.+)/(.+)'
          out: '/\1/v1/data/i18n/\2/\3'
        - name: ma_data_i18n_no_revision
          in: '/+([^/]+)/v1/data/i18n/(.+)'
          out: '/\1/v1/data/i18n/\2'
        - name: ma_page_talk
          in: '/+([^/]+)/v1/page/talk/(.+)/(.+)'
          out: '/\1/v1/page/talk/\2/\3'
        - name: ma_page_talk_no_revision
          in: '/+([^/]+)/v1/page/talk/(.+)'
          out: '/\1/v1/page/talk/\2'
        - name: ma_page_definition
          in: '/+([^/]+)/v1/page/definition/(.+)/(.+)'
          out: '/\1/v1/page/definition/\2/\3'
        - name: ma_page_definition_no_revision
          in: '/+([^/]+)/v1/page/definition/(.+)'
          out: '/\1/v1/page/definition/\2'
        - name: ma_transform_wikitext_mobile_html
          in: '/+([^/]+)/v1/transform/wikitext/to/mobile-html/(.+)'
          out: '/\1/v1/transform/wikitext/to/mobile-html/\2'
      rb_response_headers: true

    - name: proton
      timeout: 150s
      urls:
        # Proton doesn't actually support not passing a format - restbase usually adds this
        - name: proton_title
          in: '/+([^/]+)/v1/page/pdf/([^/]+)'
          out: '/\1/v1/pdf/\2/a4'
        - name: proton_title_format
          in: '/+([^/]+)/v1/page/pdf/(.+)/\b(a4|legal|letter)\b'
          out: '/\1/v1/pdf/\2/\3'
        - name: proton_title_format_type
          in: '/+([^/]+)/v1/page/pdf/(.+)/\b(a4|legal|letter)\b/(.+)'
          out: '/\1/v1/pdf/\2/\3/\4'
      rb_response_headers: true

    - name: citoid
      timeout: 120s
      ingress: true
      urls:
          # We ignore the sitename (first matching group).
          # It is assumed the URL will be properly encoded here - ie /
          # replaced by %2F if needs be
        - name: citoid_query
          in: '/+([^/]+)/v1/data/citation/(.+)/(.+)'
          out: '/\2/\3'
      rb_response_headers: true

    - name: wikifeeds
      timeout: 15s
      urls:
        - name: announcements
          in: '/+([^/]+)/v1/feed/announcements'
          out: '/\1/v1/feed/announcements'
        - name: onthisday_all
          in: '/+([^/]+)/v1/feed/onthisday/all/(.+)/(.+)'
          out: '/\1/v1/aggregated/onthisday/all/\2/\3'
        - name: onthisday
          in: '/+([^/]+)/v1/feed/onthisday/(.+)/(.+)/(.+)'
          out: '/\1/v1/feed/onthisday/\2/\3/\4'
        - name: featured
          in: '/+([^/]+)/v1/feed/featured/(.+)/(.+)/(.+)'
          out: '/\1/v1/aggregated/featured/\2/\3/\4'
        - name: availability
          in: '/+([^/]+)/v1/feed/availability'
          out: '/\1/v1/feed/availability'
        - name: configuration
          in: '/+([^/]+)/v1/feed/configuration'
          out: '/\1/v1/feed/configuration'
        - name: dyk
          in: '/+([^/]+)/v1/feed/did-you-know'
          out: '/\1/v1/feed/did-you-know'
        - name: random
          in: '/+([^/]+)/v1/page/random/(.+)'
          out: '/\1/v1/page/random/redirect/\2'
      rb_response_headers: true

    - name: geo-analytics
      timeout: 15s
      ingress: true
      urls:
        - name: api-spec
          in: '/+wikimedia.org/v1/metrics/editors/by-country/api-spec.json'
          out: '/geo-analytics/api-spec.json'
        - name: geo-editors
          in: '/+wikimedia.org/v1/metrics/editors/by-country/(.+)'
          out: '/metrics/editors/by-country/\1'
      rb_response_headers: true

    - name: media-analytics
      timeout: 15s
      ingress: true
      urls:
        - name: api-spec
          in: '/+wikimedia.org/v1/metrics/mediarequests/api-spec.json'
          out: '/mediarequests/api-spec.json'
        - name: mediarequests
          in: '/+wikimedia.org/v1/metrics/mediarequests/(.+)'
          out: '/metrics/mediarequests/\1'
      rb_response_headers: true

    - name: edit-analytics
      timeout: 5s
      ingress: true
      urls:
        - name: api-spec
          in: '/+wikimedia.org/v1/metrics/edits/api-spec.json'
          out: '/edit-analytics/api-spec.json'
        - name: edits
          in: '/+wikimedia.org/v1/metrics/edits/(.+)'
          out: '/metrics/edits/\1'
        - name: bytes_difference
          in: '/+wikimedia.org/v1/metrics/bytes-difference/(.+)'
          out: '/metrics/bytes-difference/\1'
        - name: edited_pages
          in: '/+wikimedia.org/v1/metrics/edited-pages/(.+)'
          out: '/metrics/edited-pages/\1'
      rb_response_headers: true

    - name: editor-analytics
      timeout: 5s
      ingress: true
      urls:
        - name: api-spec
          in: '/+wikimedia.org/v1/metrics/editors/api-spec.json'
          out: '/editors/api-spec.json'
        - name: edits
          in: '/+wikimedia.org/v1/metrics/editors/(.+)'
          out: '/metrics/editors/\1'
        - name: registered
          in: '/+wikimedia.org/v1/metrics/registered-users/(.+)'
          out: '/metrics/registered-users/\1'
      rb_response_headers: true

    - name: page-analytics
      timeout: 5s
      ingress: true
      urls:
        - name: api-spec
          in: '/+wikimedia.org/v1/metrics/pageviews/api-spec.json'
          out: '/page-analytics/api-spec.json'
        - name: pageviews
          in: '/+wikimedia.org/v1/metrics/pageviews/(.+)'
          out: '/metrics/pageviews/\1'
        - name: legacy
          in: '/+wikimedia.org/v1/metrics/legacy/(.+)'
          out: '/metrics/legacy/\1'
      rb_response_headers: true

    - name: device-analytics
      timeout: 15s
      urls:
        - name: api-spec
          in: '/+wikimedia.org/v1/metrics/unique-devices/api-spec.json'
          out: '/device-analytics/api-spec.json'
        - name: unique-devices
          in: '/+wikimedia.org/v1/metrics/unique-devices/(.+)'
          out: '/metrics/unique-devices/\1'
      rb_response_headers: true

    - name: commons-impact-analytics
      timeout: 15s
      ingress: true
      urls:
        - name: api-spec
          in: '/+wikimedia.org/v1/metrics/commons-analytics/api-spec.json'
          out: '/commons-impact-analytics/api-spec.json'
        - name: commons-analytics
          in: '/+wikimedia.org/v1/metrics/commons-analytics/(.+)'
          out: '/metrics/commons-analytics/\1'
      rb_response_headers: true

    - name: mw-api-ext
      timeout: 15s
      request_headers_to_add:
        - key: x-restbase-compat
          value: true
      stat_prefix: restbase-compat
      urls:
        # T374683
        # NOTE: Revision regexps come first as the title regexps are broad
        # enough to match the revision ones as well, ordering to the rescue
        # NOTE: The REST gateway, in the same spirit as RESTBase before it,
        # assumes the caller will be URL encoding the page titles so that if
        # they have slashes in them.
        #
        # e.g. Foo/Bar/Baz should become Foo%2FBar%2FBaz
        #
        # before reaching REST gateway.
        # In case a non URL encoded page with slashes is submitted, it's the
        # duty of MediaWiki to return the appropriate response (and MediaWiki
        # does return a 404)
        - name: page-metadata-revision
          in: '/+([^/]+)/v1/page/title/([^\/]+)/(.+)'
          out: '/w/rest.php/v1/revision/\3/bare'
        - name: page-metadata-title
          in: '/+([^/]+)/v1/page/title/(.+)'
          out: '/w/rest.php/v1/page/\2/bare'
        - name: page-html-revision
          in: '/+([^/]+)/v1/page/html/([^\/]+)/(.+)'
          out: '/w/rest.php/v1/revision/\3/html'
        - name: page-html-title
          in: '/+([^/]+)/v1/page/html/(.+)'
          out: '/w/rest.php/v1/page/\2/html'
        - name: lint-revision
          in: '/+([^/]+)/v1/page/lint/([^\/]+)/(.+)'
          out: '/w/rest.php/v1/transform/wikitext/to/lint/\2/\3'
        - name: lint-title
          in: '/+([^/]+)/v1/page/lint/([^\/]+)'
          out: '/w/rest.php/v1/transform/wikitext/to/lint/\2'
        - name: transform_wikitext_to_html
          in: '/+([^/]+)/v1/transform/wikitext/to/html(.*)'
          out: '/w/rest.php/v1/transform/wikitext/to/html\2'
        - name: transform_html_to_wikitext
          in: '/+([^/]+)/v1/transform/html/to/wikitext(.*)'
          out: '/w/rest.php/v1/transform/html/to/wikitext\2'
        - name: transform_wikitext_to_lint
          in: '/+([^/]+)/v1/transform/wikitext/to/lint(.*)'
          out: '/w/rest.php/v1/transform/wikitext/to/lint\2'
        # reading lists endpoint - supports all HTTP verbs for various options
        # Note use of * rather than + in regex - needed to match base
        # `/v1/data/lists/` requests which requires the trailing slash
        - name: lists
          in: '/+([^/]+)/v1/data/lists/(.*)'
          out: '/w/rest.php/readinglists/v0/lists/\2'
      rb_response_headers: true

    - name: mw-rest-php
      timeout: 15s
      # This set of routes uses the same cluster as mw-api-ext - however
      # it does NOT use the restbase compability headers as this will
      # lead to incorrect responses from the mw APIs.

      # These routes also do not use the restbase response headers as
      # we will either need to put in a more specific set of headers
      # befitting the mw apis, or to simply defer to the headers
      # mediawiki sends.
      cluster: mw-api-ext
      no_csp: true
      urls:
        # *** BEGIN rest.php APIs ***
        # campaignevents
        - name: campaignevents
          in: '/+w/rest.php/campaignevents(.*)'
          out: '/w/rest.php/campaignevents\1'
        # checkuser
        - name: checkuser
          in: '/+w/rest.php/checkuser(.*)'
          out: '/w/rest.php/checkuser\1'
        # eventbus
        - name: eventbus
          in: '/+w/rest.php/eventbus(.*)'
          out: '/w/rest.php/eventbus\1'
        # growthexperiments
        - name: growthexperiments
          in: '/+w/rest.php/growthexperiments(.*)'
          out: '/w/rest.php/growthexperiments\1'
        # ipinfo
        - name: ipinfo
          in: '/+w/rest.php/ipinfo(.*)'
          out: '/w/rest.php/ipinfo\1'
        # mathoid?
        - name: math_html
          in: '/+w/rest.php/math/v0/popup/html(.*)'
          out: '/w/rest.php/math/v0/popup/html\1'
        # oauth
        - name: oauth2
          in: '/+w/rest.php/oauth2(.*)'
          out: '/w/rest.php/oauth2\1'
        # reportincident
        - name: reportincident
          in: '/+w/rest.php/reportincident/v0/report'
          out: '/w/rest.php/reportincident/v0/report'
        # securepoll
        - name: securepoll
          in: '/+w/rest.php/securepoll(.*)'
          out: '/w/rest.php/securepoll\1'
        # sitemap
        - name: sitemap
          in: '/+w/rest.php/site/v1/sitemap(.*)'
          out: '/w/rest.php/site/v1/sitemap\1'
        # file
        - name: file
          in: '/+w/rest.php/v1/file(.*)'
          out: '/w/rest.php/v1/file\1'
        # page
        - name: page
          in: '/+w/rest.php/v1/page(.*)'
          out: '/w/rest.php/v1/page\1'
        # revision
        - name: revision
          in: '/+w/rest.php/v1/revision(.*)'
          out: '/w/rest.php/v1/revision\1'
        - name: search
          in: '/+w/rest.php/v1/search(.*)'
          out: '/w/rest.php/v1/search\1'
        # transforms - NOTE: these do not overlap (even if they
        # mirror) the existing restbase rules. restbase rules rewrite
        # restbase paths to use the same paths. Both are needed
        - name: transform
          in: '/+w/rest.php/v1/transform(.*)'
          out: '/w/rest.php/v1/transform\1'
        # flaggedrevs
        - name: flaggedrevs
          in: '/+w/rest.php/flaggedrevs(.*)'
          out: '/w/rest.php/flaggedrevs\1'
        # searchvue
        - name: searchvue
          in: '/+w/rest.php/searchvue(.*)'
          out: '/w/rest.php/searchvue\1'
        # wikifunctions
        - name: wikifunctions
          in: '/+w/rest.php/wikifunctions(.*)'
          out: '/w/rest.php/wikifunctions\1'
        - name: wikimediacampaignevents
          in: '/+w/rest.php/wikimediacampaignevents(.*)'
          out: '/w/rest.php/wikimediacampaignevents\1'
        - name: content
          in: '/+w/rest.php/content(.*)'
          out: '/w/rest.php/content\1'
        - name: specs
          in: '/+w/rest.php/specs(.*)'
          out: '/w/rest.php/specs\1'
        - name: wikibase
          in: '/+w/rest.php/wikibase(.*)'
          out: '/w/rest.php/wikibase\1'
        # This case catches remaining rest.php traffic that is not
        # matched by any existing rule. This shouldn't be something we
        # hit, and if it is regularly hit it should be investigated to
        # add suitable rules.
        - name: rest_php_unmatched
          in: '/+w/rest.php(.*)'
          out: '/w/rest.php\1'
        # *** END rest.php APIs ***

  discovery_endpoints:
    # Remember to add the corresponding svc.$dc.wmnet entry in egress
    mobileapps:
      tls: true
      port: 4102
    proton:
      tls: true
      port: 4030
    citoid:
      ingress: true
      port: 30443 # ingress
      tls: true
      internal_host: citoid-ingress.discovery.wmnet
    wikifeeds:
      tls: true
      port: 4101
    device-analytics:
      port: 4972
      tls: true
    geo-analytics:
      ingress: true
      port: 30443 # ingress
      tls: true
    media-analytics:
      ingress: true
      port: 30443 # ingress
      tls: true
    page-analytics:
      ingress: true
      port: 30443 # ingress
      tls: true
    edit-analytics:
      ingress: true
      port: 30443 # ingress
      tls: true
    editor-analytics:
      ingress: true
      port: 30443 # ingress
      tls: true
    commons-impact-analytics:
      ingress: true
      port: 30443 # ingress
      tls: true
    mw-api-ext:
      tls: true
      port: 4447
      # T405955: Divert requests with the PHP_ENGINE=8.3 cookie to mw-api-ext-next.
      php_engine_routing:
        "8.3":
          service_name: mw-api-ext-next
          port: 4455

service:
  deployment: production
  port:
    nodePort: 4113

mesh:
  enabled: true
  telemetry:
    enabled: true
  certmanager:
    extraFQDNs:
      - '*.m.mediawiki.org'
      - '*.m.wikibooks.org'
      - '*.wikipedia.org'
      - '*.m.wikidata.org'
      - '*.m.wikimedia.org'
      - '*.m.wikimediafoundation.org'
      - '*.m.wikinews.org'
      - '*.m.wikipedia.org'
      - '*.m.wikiquote.org'
      - '*.m.wikisource.org'
      - '*.m.wikiversity.org'
      - '*.m.wikivoyage.org'
      - '*.m.wiktionary.org'
      - '*.mediawiki.org'
      - '*.planet.wikimedia.org'
      - '*.wikibooks.org'
      - '*.wikidata.org'
      - '*.wikimedia.org'
      - '*.wikimediafoundation.org'
      - '*.wikinews.org'
      - '*.wikiquote.org'
      - '*.wikisource.org'
      - '*.wikiversity.org'
      - '*.wikivoyage.org'
      - '*.wiktionary.org'
      - '*.wmfusercontent.org'
      - '*.zero.wikipedia.org'
      - 'mediawiki.org'
      - 'w.wiki'
      - 'wikibooks.org'
      - 'wikidata.org'
      - 'wikimedia.org'
      - 'wikimediafoundation.org'
      - 'wikinews.org'
      - 'wikiquote.org'
      - 'wikisource.org'
      - 'wikiversity.org'
      - 'wikivoyage.org'
      - 'wiktionary.org'
      - 'wmfusercontent.org'
      - 'wikipedia.org'

discovery:
  listeners:
  - mobileapps

networkpolicy:
  egress:
    enabled: true
    dst_nets:
    - cidr: 10.2.1.14/32 # mobileapps.svc.codfw.wmnet
      ports:
        - protocol: tcp
          port: 4102
    - cidr: 10.2.2.14/32 # mobileapps.svc.eqiad.wmnet
      ports:
        - protocol: tcp
          port: 4102
    - cidr: 10.2.1.21/32 # proton.svc.codfw.wmnet
      ports:
        - protocol: tcp
          port: 4030
    - cidr: 10.2.2.21/32 # proton.svc.eqiad.wmnet
      ports:
        - protocol: tcp
          port: 4030
    - cidr: 10.2.1.47/32 # wikifeeds.svc.codfw.wmnet
      ports:
        - protocol: tcp
          port: 4101
    - cidr: 10.2.2.47/32 # wikifeeds.svc.eqiad.wmnet
      ports:
        - protocol: tcp
          port: 4101
    - cidr: 10.2.1.19/32 # citoid.svc.codfw.wmnet
      ports:
        - protocol: tcp
          port: 4003
    - cidr: 10.2.2.19/32 # citoid.svc.eqiad.wmnet
      ports:
        - protocol: tcp
          port: 4003
    - cidr: 10.2.2.70/32 # k8s-ingress-wikikube-ro.discovery.wmnet (eqiad)
      ports:
        - protocol: tcp
          port: 30443
    - cidr: 10.2.1.70/32 # k8s-ingress-wikikube-ro.discovery.wmnet (codfw)
      ports:
        - protocol: tcp
          port: 30443
    - cidr: 10.2.2.69/32 # *.k8s-staging.discovery.wmnet (eqiad)
      ports:
        - protocol: tcp
          port: 30443
    - cidr: 10.2.1.69/32 # *.k8s-staging.discovery.wmnet (codfw)
      ports:
        - protocol: tcp
          port: 30443
    - cidr: 10.2.2.80/32 # device-analytics.discovery.wmnet (eqiad)
      ports:
        - protocol: tcp
          port: 4972
    - cidr: 10.2.1.80/32 # device-analytics.discovery.wmnet (codfw)
      ports:
        - protocol: tcp
          port: 4972
    - cidr: 10.2.2.76/32 # mw-api-ext.discovery.wmnet (eqiad)
      ports:
        - protocol: tcp
          port: 4447
    - cidr: 10.2.1.76/32 # mw-api-ext.discovery.wmnet (codfw)
      ports:
        - protocol: tcp
          port: 4447
    - cidr: 10.2.2.7/32 # mw-api-ext-next.discovery.wmnet (eqiad)
      ports:
        - protocol: tcp
          port: 4455
    - cidr: 10.2.1.7/32 # mw-api-ext-next.discovery.wmnet (codfw)
      ports:
        - protocol: tcp
          port: 4455
